<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>地理老子App </title>
<style>
  /* Reset */
  * {
    margin: 0; padding: 0; box-sizing: border-box;
    -webkit-tap-highlight-color: transparent;
  }
  body,html {
    height: 100%;
    font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", Helvetica, Arial, sans-serif;
    background: #f9f9f9;
    overflow: hidden;
    -webkit-user-select: none;
  }
  #app {
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  header {
    height: 50px;
    background: #007AFF;
    color: white;
    font-weight: 600;
    font-size: 18px;
    line-height: 50px;
    text-align: center;
    user-select:none;
  }
  #contentWrapper {
    flex: 1;
    overflow-x: hidden;
    position: relative;
  }
  #content {
    display: flex;
    height: 100%;
    transition: transform 0.3s ease;
  }
  section {
    min-width: 100vw;
    padding: 12px 16px 80px 16px;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
    background: white;
    border-left: 1px solid #eee;
  }
  section:first-child {
    border-left: none;
  }
  section h2 {
    font-weight: 600;
    margin-bottom: 8px;
    font-size: 20px;
    color: #222;
  }
  .question {
    margin-bottom: 18px;
    border-bottom: 1px solid #eee;
    padding-bottom: 10px;
  }
  .q-title {
    font-weight: 500;
    margin-bottom: 8px;
    font-size: 16px;
    color: #333;
  }
  label.option {
    display: flex;
    align-items: center;
    padding: 6px 10px;
    margin-bottom: 6px;
    border-radius: 12px;
    border: 1px solid #ccc;
    font-size: 15px;
    user-select:none;
    cursor: pointer;
    transition: background-color 0.15s ease;
  }
  label.option input {
    margin-right: 10px;
    flex-shrink: 0;
  }
  label.option:hover {
    background: #e6f0ff;
  }
  label.option.correct {
    background: #d4edda;
    border-color: #28a745;
    color: #155724;
  }
  label.option.incorrect {
    background: #f8d7da;
    border-color: #dc3545;
    color: #721c24;
  }
  .correct-answer-mark, .incorrect-answer-mark {
    margin-left: auto;
    font-weight: bold;
    font-size: 18px;
    user-select:none;
  }
  .correct-answer-mark {
    color: #28a745;
  }
  .incorrect-answer-mark {
    color: #dc3545;
  }
  #submit-btn {
    position: fixed;
    bottom: 15px;
    left: 50%;
    transform: translateX(-50%);
    width: 90vw;
    max-width: 600px;
    height: 45px;
    background: #007AFF;
    border: none;
    border-radius: 24px;
    color: white;
    font-size: 18px;
    font-weight: 600;
    box-shadow: 0 4px 10px rgba(0,122,255,0.3);
    cursor: pointer;
    user-select:none;
    outline: none;
  }
  #submit-btn:active {
    background: #005ecb;
  }
  #nav-arrows {
    position: fixed;
    top: 50%;
    width: 100%;
    pointer-events: none;
  }
  .arrow {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 30px;
    height: 30px;
    background: rgba(0,0,0,0.15);
    border-radius: 50%;
    line-height: 30px;
    text-align: center;
    color: white;
    font-size: 22px;
    user-select:none;
    pointer-events: auto;
    cursor: pointer;
    transition: background 0.3s ease;
  }
  .arrow:hover {
    background: rgba(0,0,0,0.35);
  }
  #arrow-left {
    left: 10px;
  }
  #arrow-right {
    right: 10px;
  }
  /* Scrollbar for ios */
  section::-webkit-scrollbar {
    height: 4px;
    width: 4px;
  }
  section::-webkit-scrollbar-thumb {
    background-color: rgba(0,0,0,0.1);
    border-radius: 2px;
  }
</style>
</head>
<body>
<div id="app">
  <header>做题App</header>
  <div id="contentWrapper">
    <div id="content"></div>
  </div>
  <button id="submit-btn">提交本章答案</button>
  <div id="nav-arrows">
    <div id="arrow-left" class="arrow" title="上一章" style="display:none;">‹</div>
    <div id="arrow-right" class="arrow" title="下一章" style="display:none;">›</div>
  </div>
</div>

<script>
  // 判断是否多选
  function isMultiChoice(sectionTitle) {
    return sectionTitle.includes("多选题");
  }

  // 变量存储数据和状态
  let questionData = null;
  let answerData = null;
  let sections = [];
  let currentPage = 0;

  // 渲染所有章节页
  function renderQuestions(questions) {
    const content = document.getElementById("content");
    content.innerHTML = "";
    sections = Object.keys(questions);

    sections.forEach((sectionTitle, idx) => {
      const sectionEl = document.createElement("section");
      sectionEl.setAttribute("data-section-index", idx);
      sectionEl.style.minWidth = window.innerWidth + "px";

      // 章节标题
      const h2 = document.createElement("h2");
      h2.textContent = sectionTitle;
      sectionEl.appendChild(h2);

      const isMulti = isMultiChoice(sectionTitle);
      const questionList = questions[sectionTitle];

      questionList.forEach((fullQStr, index) => {
        const qNo = (index + 1).toString();

        // 解析题干和选项（同之前）
        const parts = fullQStr.split(/([A-Z]\.)/);
        const questionText = parts[0].trim();
        const options = [];
        for (let i = 1; i < parts.length; i += 2) {
          const letter = parts[i].replace(".", "").trim();
          const text = parts[i + 1].trim();
          options.push(letter + ". " + text);
        }

        const questionDiv = document.createElement("div");
        questionDiv.classList.add("question");
        questionDiv.dataset.section = sectionTitle;
        questionDiv.dataset.qno = qNo;

        const qTitle = document.createElement("div");
        qTitle.classList.add("q-title");
        qTitle.textContent = `${qNo}. ${questionText}`;
        questionDiv.appendChild(qTitle);

        const inputType = isMulti ? "checkbox" : "radio";
        const safeSection = sectionTitle.replace(/\s+/g, "_");

        options.forEach(opt => {
          const optLetter = opt[0];
          const inputId = `${safeSection}-${qNo}-${optLetter}`;

          const label = document.createElement("label");
          label.classList.add("option");
          label.setAttribute("for", inputId);
          label.textContent = opt;

          const input = document.createElement("input");
          input.type = inputType;
          input.name = `${safeSection}-${qNo}`;
          input.id = inputId;
          input.value = optLetter;

          label.prepend(input);
          questionDiv.appendChild(label);
        });

        sectionEl.appendChild(questionDiv);
      });

      content.appendChild(sectionEl);
    });

    updateNavButtons();
    updateContentPosition();
  }

  // 切换页面时更新内容位置
  function updateContentPosition() {
    const content = document.getElementById("content");
    const width = window.innerWidth;
    content.style.transform = `translateX(${-currentPage * width}px)`;
  }

  // 左右箭头控制
  const arrowLeft = document.getElementById("arrow-left");
  const arrowRight = document.getElementById("arrow-right");
  arrowLeft.onclick = () => {
    if (currentPage > 0) {
      currentPage--;
      updateContentPosition();
      updateNavButtons();
      clearMarksOnPage(currentPage + 1); // 清除右侧页面标记
    }
  };
  arrowRight.onclick = () => {
    if (currentPage < sections.length - 1) {
      currentPage++;
      updateContentPosition();
      updateNavButtons();
      clearMarksOnPage(currentPage - 1); // 清除左侧页面标记
    }
  };

  // 显示或隐藏箭头
  function updateNavButtons() {
    arrowLeft.style.display = currentPage === 0 ? "none" : "block";
    arrowRight.style.display = currentPage === sections.length - 1 ? "none" : "block";
  }

  // 滑动支持（简单touch事件实现）
  let touchStartX = 0;
  let touchEndX = 0;
    const contentWrapper = document.getElementById("contentWrapper");
  contentWrapper.addEventListener("touchstart", e => {
    touchStartX = e.changedTouches[0].screenX;
  });
  contentWrapper.addEventListener("touchend", e => {
    touchEndX = e.changedTouches[0].screenX;
    handleGesture();
  });

  function handleGesture() {
    const delta = touchEndX - touchStartX;
    const threshold = 50; // 最小滑动距离判定

    if (delta > threshold && currentPage > 0) {
      // 向右滑，上一页
      currentPage--;
      updateContentPosition();
      updateNavButtons();
      clearMarksOnPage(currentPage + 1);
    } else if (delta < -threshold && currentPage < sections.length -1) {
      // 向左滑，下一页
      currentPage++;
      updateContentPosition();
      updateNavButtons();
      clearMarksOnPage(currentPage - 1);
    }
  }

  // 清除指定页（章节）标记样式，避免上一页遗留色彩
  function clearMarksOnPage(pageIndex) {
    if (pageIndex < 0 || pageIndex >= sections.length) return;
    const sectionTitle = sections[pageIndex];
    const sectionEl = document.querySelector(`section[data-section-index="${pageIndex}"]`);
    if (!sectionEl) return;

    sectionEl.querySelectorAll("label.option").forEach(label => {
      label.classList.remove("correct", "incorrect");
      const mark = label.querySelector(".correct-answer-mark, .incorrect-answer-mark");
      if (mark) mark.remove();
    });
  }

  // 提交按钮判分
  const submitBtn = document.getElementById("submit-btn");
  submitBtn.onclick = () => {
    const sectionTitle = sections[currentPage];
    const isMulti = isMultiChoice(sectionTitle);
    const correctAnswers = answerData[sectionTitle] || {};

    const sectionEl = document.querySelector(`section[data-section-index="${currentPage}"]`);
    if (!sectionEl) return;

    let total = 0;
    let correctCount = 0;

    // 遍历每题
    sectionEl.querySelectorAll(".question").forEach(qDiv => {
      total++;
      const qNo = qDiv.dataset.qno;
      const correctAns = correctAnswers[qNo] ? correctAnswers[qNo].toUpperCase() : "";

      // 获取用户选项（字母数组，排序后拼字符串）
      const checkedOptions = [];
      qDiv.querySelectorAll("input:checked").forEach(input => {
        checkedOptions.push(input.value.toUpperCase());
      });
      checkedOptions.sort();
      const userAns = checkedOptions.join("");

      // 判断是否正确
      const isCorrect = userAns === correctAns;

      if (isCorrect) correctCount++;

      // 标记选项颜色
      qDiv.querySelectorAll("label.option").forEach(label => {
        const input = label.querySelector("input");
        const val = input.value.toUpperCase();
        label.classList.remove("correct", "incorrect");
        const oldMark = label.querySelector(".correct-answer-mark, .incorrect-answer-mark");
        if (oldMark) oldMark.remove();

        if (correctAns.includes(val) && userAns.includes(val)) {
          // 选对的选项
          label.classList.add("correct");
          const mark = document.createElement("span");
          mark.className = "correct-answer-mark";
          mark.textContent = "✓";
          label.appendChild(mark);
        } else if (userAns.includes(val) && !correctAns.includes(val)) {
          // 选错的选项
          label.classList.add("incorrect");
          const mark = document.createElement("span");
          mark.className = "incorrect-answer-mark";
          mark.textContent = "✗";
          label.appendChild(mark);
        } else if (correctAns.includes(val) && !userAns.includes(val)) {
          // 正确但未选的（多选题时）
          // 也可以提示，但这里不特别标记
        }
      });
    });

    alert(`本章共${total}题，您答对了${correctCount}题，正确率${((correctCount / total) * 100).toFixed(2)}%`);
  };

  // 监听窗口宽度变化，动态调整section宽度和位置
  window.addEventListener("resize", () => {
    const width = window.innerWidth;
    document.querySelectorAll("#content > section").forEach(sec => {
      sec.style.minWidth = width + "px";
    });
    updateContentPosition();
  });

  // 加载本地json文件函数
  async function loadJSON(file) {
    const res = await fetch(file);
    if (!res.ok) throw new Error(`加载${file}失败: ${res.status}`);
    return await res.json();
  }

  // 启动入口，加载两个json，渲染
  async function init() {
    try {
      questionData = await loadJSON("question.json");
      answerData = await loadJSON("answer.json");
      renderQuestions(questionData);
    } catch (e) {
      alert("加载数据失败，请确保question.json和answer.json在同目录并通过HTTP(S)协议访问。\n错误信息：" + e.message);
      console.error(e);
    }
  }

  init();

</script>
</body>
</html>